This is a tool intended to read scheduled games from the published Team 4545 website ([http://team4545league.org/tournament/games.html](http://team4545league.org/tournament/games.html)), and add them to managed Google Calendars.

These calendars can be configured to “watch” for specific players, teams or divisions, and can be helpful for players or TDs who should be aware of many games per week that they may or may not be playing in.

**Implementation**

The tool is implemented on Google Cloud as a Cloud Function. It is currently set up on Cloud Scheduler to run every 10 minutes. It checks the state of the website, and compares the list of published games to the current list of managed games. Currently, if a targeted game is on the site, but not in the calendar, it gets added. If the game is in the calendar, but not on the site, it gets removed. The code expects a Pub/Sub topic message as an input to the hello\_http() method in main.py, but it’s actually generated by the scheduler to perform the task “update”, described above. The code, as-is can also be run from a command line, with the possible commands configurable in the “main.py “main” code. It would be better for the command loop to be either (both?) interactive or to read the requests from a command file, so it isn’t a code change to simply test the application.

Note that in theory, you don’t need to manage the game state in the local bucket data, the event is either on the managed calendar or it’s not. As a practical matter, it was easier to do this to track games that might have been rescheduled to try to avoid duplicated. Might want to rethink this.

**Artifacts**

There are two - the list of managed Google Calendars, and a “config.json” file inside a Cloud Bucket in the hosting project named “jpd-t4545-calendar-manager”

The calendars all exist under my personal account for now - they are acted on by the service account that runs the service, which has access to my calendar space. THIS IS NOT SCALABLE, OR EVEN GOOD.

**Defined Actions**

Note that these are given to the program as base64encoded strings in the \[“message”\]\[“data”\] portion of the input request. From the code, this is how the action is obtained:

*   update - reads the current games data from the T4545 site, updates the local managed state and external events on the calendar, and rewrites local state as needed
    
*   display - writes to console (which ends up in the logs) the current contents of all managed calendars, including config and currently active events
    
*   init - this resets the state of the bucket data and calls “remove\_calendar” for all calendars
    
*   edit - allows for modification of tracked teams, players and divisions for existing calendars
    
*   add\_calendar -adds an element to the structure and attempts to create a calendar object to be managed going forward
    
*   remove\_calendar -clears (known) events from the actual calendars
    
*   quit - defined but is meaningless headless (and takes no current action from the command line…)
    

**To-Do**

1.  DONE - Fix the problem with updated games
    
2.  DONE - interactive command loop
    
3.  allow the tool to use other calendar contexts
    
4.  DONE - allow the tool to read PGN from games as they complete
    
5.  DONE - let games expire some time after they disappear from the website (configurable? by calendar??)
    
6.  remove game state from the bucket - simply refer to the real world on the calendar
7.  rename the calendar / data file from config.json to something more descriptive
8.  DONE - extract runtime parameters to separate file to be added at deploy time - in runtime-parameters.json

    

**Technical Design**

The code is written in Python 3.7+, and relies on various Google Cloud libraries, in requirements.txt.

functions\_framework allows the code to receive Cloud Function triggers, cloud-storage makes the bucket API available, BeautifulSoup4 is used to wrangle the T4545 site html, and the google-api-python-client brings gcp to life…

New code files added (also refactored some of the code to make it clearer - have NOT yet updated the below doc):
* config_data.py, pulls account, bucket, and other configurables from a runtime-parameters.json  in the same bucket as the data file
* cloudbuild.yaml - context for Cloud Buikd to pull and deploy from the github repo with no human interaction on checkin
* runtime-parameters.json - injectable parameters as noted above

There are only 6 code files. Originally these were broken out as:

*   main.py - entry points and central action logic
    
    *   constant info helper functions - perhaps should better be defines
        
        *   project\_id() - “t4545-calendar-manager”
            
        *   local\_bucket\_id() - “jpd-t4545-calendar-manager”
            
        *   local\_bucket\_blob() - “config.json”
            
        *   token\_credential\_blob() - “token.json”
            
        *   games\_url() - “[http://team4545league.org/tournament/games.html](http://team4545league.org/tournament/games.html)"
            
    *   interactive entry point
        
        *   typically calls helper functions to perform specific actions
            
    *   helper functions do\_update(), do\_display(), add\_team(), remove\_team(), add\_player(), remove\_player(), add\_division(), remove\_division()
        
        *   each of these simply constructs a generic msg and adds the appropriate attributes for the given task, and calls do\_command() with that message
            
        *   each (except update/display) takes string arguments (cal\_name, X\_name) the text name of the calendar to be updated and the name of the entity to be modified
            
    *   do\_command()
        
        *   takes the generic msg and packages it as a request so the main pub/sub command loop entry point hello\_http() can process it, and calls that function. This was done to help ensure that there was no “different action path” for interactive vs scheduled vs (eventually) pub/sub driven
            
    *   template\_msg, sample\_add\_msg, sample\_upd\_msg
        
        *   used during original debugging (and before the helper functions above) to help ensure we were running correctly
            
        *   all of the helper functions use template\_msg as their base, but do NOT properly update any of the ID’s or times - these are not used by the application currently
            
    *   hello\_http()
        
        *   this is the main entry point, and expects a PubSub message as its argument
            
        *   action verb and appropriate arguments are extracted from the message (as shown above) and passed to the run\_task() function
            
    *   run\_task()
        
        *   this is the worker function that performs the actions for each verb
            
        *   display
            
            *   get calendars from bucket, and print all of them
                
        *   update
            
            *   get calendars from bucket
                
            *   get game data from external URL
                
            *   call update\_events() on shared calendar
                
            *   if anything was updated
                
                *   Open the Google Calendars object, and call update\_events on the Calendar\_IO object
                    
                *   write the bucket with the updated data
                    
        *   init
            
            *   execute “remove\_calendar” with a list of all currently managed IDs
                
        *   edit
            
            *   Init the current managed calendars from the bucket
                
            *   call edit\_calendar on any calendar object specified by the arguments given
                
        *   add\_calendar
            
            *   check to see if the requested name already exists, if not:
                
                *   call new\_calendar() on the Calendar\_IO object with the right arguments
                    
                *   if this call was successful:
                    
                    *   call add\_calendar() to build the new entry in the managed calendar structure
                        
                    *   write data back out to the bucket
                        
        *   remove\_calendar
            
            *   get the current managed calendar data from the bucket
                
            *   for each calendar specified as to be deleted
                
                *   Calendars\_IO.delete\_calendar() to delete this calendar from the external service
                    
                *   Calendars.remove\_calendar() to remove this calendar from the managed calendar list
                    
            *   write the data back out to the bucket
                
        *   quit
            
            *   nop
                

*   LogDetail.py - included to make log entries more legible, although all console writes get pulled into the logging environment
    
    *   get\_logtime() - creates an appropriately formatted timestring to be used in log messages
        
    *   print log() - writes a message to console, also calls logging infrastructure and creates a RuntimeError() object in case of an actual logged error
        

*   IO Classes - deal with the externalities of these objects and turn them into logical entities to be managed by the other classes (not so airtight, in reality)
    
    *   Bucket\_IO.py - generic class to read/write json dictionary from a bucket
        
        *   constructor
            
            *   set project, bucket, and file locations
                
        *   read\_data()
            
            *   load the json from the bucket and return the dictionary
                
        *   write\_data()
            
            *   write the given json to the bucket
                
    *   Calendar\_IO.py
        
        *   constructor
            
            *   set project, bucket, and file locations, and calendar scopes
                
        *   get\_credentials\_from\_bucket() - read token data from bucket, uses Bucket\_IO
            
        *   write\_credentials\_to\_bucket() - write token data from bucket, uses Bucket\_IO
            
        *   get\_credentials()
            
            *   get and validate credentials from bucket
                
            *   if they’re not valid, try to let the user login - NOTE, this should log as an error, especially when operating headless, and not attempt refresh in that case
                
        *   new\_calendar()
            
            *   get credentials, and try to build a calendar service object
                
            *   build a dictionary object to generate a new calendar
                
            *   insert into the calendars() list for the current context
                
            *   return the id from the insertion object
                
        *   delete\_calendar()
            
            *   get credentials, and try to build a calendar service object
                
            *   delete this item from the calendars() list for the current context
                
        *   remove\_from\_calendar()
            
            *   for the given event / calendar
                
            *   get credentials, and try to build a calendar service object
                
            *   remove the event at event\[“eventId”\] from the calendar at calendar\[“access”\]\[“url”\]
                
        *   add\_to\_calendar()
            
            *   for the given event / calendar
                
            *   get credentials, and try to build a calendar service object
                
            *   build the timestring in the right format for the new event
                
            *   build a dictionary item for the rest of the event detail
                
            *   add the event from the dictionary to the calendar at calendar\[“access”\]\[“url”\] , and save the returned id at event\[“eventId”\]
                
        *   update\_events()
            
            *   for each calendar in the provided dictionary object:
                
                *   if this \[“status”\] = “removed”, then delete the calendar from the list
                    
                *   for each event in this calendar that’s removed
                    
                    *   remove\_from\_calendar to remove from the actual calendar
                        
                    *   remove from the events list
                        
                *   for each event in this calendar that’s updated
                    
                    *   if an old ID exists - remove from the calendar
                        
                    *   add\_to\_calendar to add to the actual calendar
                        
        *   test\_calendar()
            
            *   build a known good calendar and event object
                
            *   call add\_to\_calendar() with this information
                
    *   Games\_IO.py - generic file to get html\_content from a given url
        
        *   get\_games\_data()
            
            *   request data
                
            *   check response code (does not use the LogDetail class…)
                
            *   return html\_content
                

*   Calendars.py - the abstract object that managed all state and worked with the X\_IO classes as needed
    
    *   effectively just a list of dictionary objects, saved as JSON to the bucket
        
        *   should this be a dictionary…??
            
    *   constructor
        
        *   sets ALL managed calendars to have \[“status'\] = “loaded” - to tell later if something else changed their state…
            
        *   sets ALL events in all managed calendars to have \[“status'\] = “loaded” - to tell later if something else changed their state…
            
    *   edit\_calendar (static - why?)
        
        *   modifies the player/division/team lists based on the provided attributes
            
        *   also can be used to update the respondEmail for this calendar
            
    *   update\_attribute\_list(static - why?)
        
        *   modifies the specific list given, called by edit\_calendar
            
    *   update\_events()
        
        *   This is the worker function for this module. Expects the calendar data to be initialized, and takes html\_data from the games site as input
            
        *   for each calendar
            
            *   init update stats for this calendar(updated, incoming, updated, discovered, written, removed - should true up…)
                
            *   parse the incoming game html
                
            *   for each game
                
                *   if this calendar cares about this game
                    
                    *   build the key for this game
                        
                    *   if not in current events,
                        
                    *   \- add to events calendar as \[“status'\] = “updated”
                        
                    *   else
                        
                    *   \- if time matches, set as \[“status'\] = “validated”
                        
                    *   \- else update time, save old id and set as \[“status'\] = “updated”
                        
            *   for each event in the calendar
                
                *   if \[“status'\] = “loaded”, update to \[“status'\] = “removed”
                    
    *   clear\_all\_calendars()
        
        *   DEPRECATED - not used elsewhere in code
            
        *   marks all events in calendars with \[“status'\] = “removed”
            
    *   remove\_all\_calendars()
        
        *   DEPRECATED - not used elsewhere in code
            
        *   marks all calendars with \[“status'\] = “removed”
            
    *   add\_calendar()
        
        *   builds an appropriate dictionary structure representing the args given, and adds it to the list of managed calendars
            
    *   remove\_calendar()
        
        *   simply removes the named calendar from the list of managed calendars